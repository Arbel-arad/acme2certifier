<!-- markdownlint-disable  MD013 -->
<!-- wiki-title CA handler for OpenXPKI -->
# Connecting to OpenXPKI

This handler can be use to enroll certificates from [OpenxPKI](https://www.openxpki.org/) as ACME support seems to be available in a commercial version only.

Altough conenction is already possible via the [generic EST CA handler](est.md) this handler should preferred as it supports revocation operation and the ability to specify a [certifiate-profiles](https://openxpki.readthedocs.io/en/stable/reference/configuration/profile.html)

## Prerequisites

- [OpenXPKI](https://www.openxpki.org/) with activated [RPC server](https://openxpki.readthedocs.io/en/stable/subsystems/rpc.html)
- you'll need:
  - a RPC endpoint supporting `RequestCertificate`, `RevokeCertificate` and `SearchCertificate` as decribed in the [example configuration](https://github.com/openxpki/openxpki-config/blob/community/rpc/enroll.conf)
  - a client certificate and key in pem format to authenticate towards the RPC-service
  - a [certificate profile](https://openxpki.readthedocs.io/en/stable/reference/configuration/profile.html)

# OpenXPKI configuration

The OpenXPKI configuration needs to be adjusted

- the hander expects a full key chain (including the root certififcate) to be delivered.  You need to adjust the `export_certificate` paramter in the endpoint configuration file stored in `config.d/realm.tpl/rpc/`

```yaml
policy:
      export_certificate: fullchain
```

- Although certificate polling by the handler is supporting by setting the `polling_timeout` parameter it is recommended to skip manual or dual approval to ensure smooth enrollment operations.  We recommend to set the `approval_points` paramter in the endpoint configuration file configuration file stored in `config.d/realm.tpl/rpc/` to 1

```yaml
policy:
      approval_points: 1
```

- CSRs generated by some acme clients like [certbot](https://certbot.eff.org/) do not contain any subject name which get refused by OpenXPKI. We overcame this issue by modifying the certificate profile stored in `config.d/realm.tpl/profile/` in a way that the first subject alternate name from the CSR will be used as common name.

```yaml
style:
    # rpc endpoint name, in our example enroll
    enroll:
        subject:
            dn: CN=[% SAN_DNS.0 %]
```

## Configuration

- modify the server configuration (`/acme_srv/acme_srv.cfg`) and add the following parameters

```config
[CAhandler]
handler_file: examples/ca_handler/openxpki_ca_handler.py
host: <URL>
client_key: <filename>
client_cert: <filename>
ca_bundle: <filename>
cert_profile_name: <name>
endpoint_name: <name>
polling_timeout: <seconds>
```

- host - URL of the OpenXPKI-server
- cert_file - certicate in PEM format used authenticate towards OpenXPKI
- key_file - key file in PEM format used to authenticate towards OpenXPKI
- ca_bundle - optional - ca certificate cahin in pem format needed to validate the ejbca-server certificate - can be True/False or a filename (default: True)
- cert_profile_name - name of the certificate profile
- ee_profile_name - name of the end entity profile
- polling_timeout - timeout in seconds for enrollment operations (default 0 - polling disabled)
- request_timeout - optional - requests timeout in seconds for requests (default: 5s)

Use your favorite acme client for certificate enrollment. A list of clients used in our regression can be found inthe [disclaimer section of our README file](../README.md)
